//  Copyright 2014 IBM
//
//   Licensed under the Apache License, Version 2.0 (the "License");
//   you may not use this file except in compliance with the License.
//   You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
//   Unless required by applicable law or agreed to in writing, software
//   distributed under the License is distributed on an "AS IS" BASIS,
//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//   See the License for the specific language governing permissions and
//   limitations under the License.

extends ../../layout
block content
  h1=title
  script(type='text/javascript').
    function queryProviders() {
      $.ajax({
        url: "/api4gui/v1/providers/",
        type: "GET",
        success: function(json) {
          if ($.isEmptyObject(json)) {
            alert( "please define the topology providers first!" );
            return;
          }
          json.forEach(function(provider) {
            if (provider.id == "#{topology.providerRef}") {
              $('#div_provider select').append('<option value="' + provider._id + '" selected="selected">' + provider.name + '</option>');
            } else {
              $('#div_provider select').append('<option value="' + provider._id + '">' + provider.name + '</option>');
            }
          });
        },
        error: function( xhr, status, errorThrown ) {
            alert( "Sorry, there was a problem to get providers!" );
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
        }
      });
    }
    function queryApplications(providerId) {
      $.ajax({
        url: '/api4gui/v1/providers/' + providerId + '/',
        type: "GET",
        success: function(provider) {
          $.ajax({
            url: '/rest/ucd/applications',
            type: "GET",
            beforeSend: function(xhr) {
              xhr.setRequestHeader('UCD_SERVER', provider.UCD_SERVER);
              xhr.setRequestHeader('UCD_USERNAME', provider.UCD_USERNAME);
              xhr.setRequestHeader('UCD_PASSWORD', provider.UCD_PASSWORD);
            },
            success: function(json) {
              if ($.isEmptyObject(json)) {
                alert( "Cannot find any applications in specified provider!" );
                return;
              }
              json.forEach(function(application) {
                if (application.name == "#{topology.appName}") {
                  $('#div_application select').append('<option value="' + application.name + '" selected="selected">' + application.name + '</option>');
                } else {
                  $('#div_application select').append('<option value="' + application.name + '">' + application.name + '</option>');
                }
              });
            },
            error: function( xhr, status, errorThrown ) {
              console.log( "Error: " + errorThrown );
              console.log( "Status: " + status );
            }
          });
        },
        error: function( xhr, status, errorThrown ) {
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
        }
      });
    }
    function queryBlueprints(providerId, appName) {
      console.log("appName:" + appName);
      $.ajax({
        url: '/api4gui/v1/providers/' + providerId + '/',
        type: "GET",
        success: function(provider) {
          $.ajax({
            url: '/rest/ucd/applications/' + appName + '/blueprints',
            type: "GET",
            beforeSend: function(xhr) {
              xhr.setRequestHeader('UCD_SERVER', provider.UCD_SERVER);
              xhr.setRequestHeader('UCD_USERNAME', provider.UCD_USERNAME);
              xhr.setRequestHeader('UCD_PASSWORD', provider.UCD_PASSWORD);
            },
            success: function(json) {
              if ($.isEmptyObject(json)) {
                alert( "Cannot find any blueprints in specified application!" );
                return;
              }
              json.forEach(function(blueprint) {
                if (blueprint.name == "#{topology.blueprintName}") {
                  $('#div_blueprint select').append('<option value="' + blueprint.name + '" selected="selected">' + blueprint.name + '</option>');
                } else {
                  $('#div_blueprint select').append('<option value="' + blueprint.name + '">' + blueprint.name + '</option>');
                }
              });
            },
            error: function( xhr, status, errorThrown ) {
              console.log( "Error: " + errorThrown );
              console.log( "Status: " + status );
            }
          });
        },
        error: function( xhr, status, errorThrown ) {
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
        }
      });
    }
    function queryNodeProperties(providerId, appName, blueprintName) {
      $.ajax({
        url: '/api4gui/v1/providers/' + providerId + '/',
        type: "GET",
        success: function(provider) {
          $.ajax({
            url: '/rest/ucd/applications/' + appName + '/blueprints/' + blueprintName,
            type: "GET",
            beforeSend: function(xhr) {
              xhr.setRequestHeader('UCD_SERVER', provider.UCD_SERVER);
              xhr.setRequestHeader('UCD_USERNAME', provider.UCD_USERNAME);
              xhr.setRequestHeader('UCD_PASSWORD', provider.UCD_PASSWORD);
            },
            success: function(nodeProperties) {
              $('#div_nodeprops textarea').val(JSON.stringify(nodeProperties, null, 4));
            },
            error: function( xhr, status, errorThrown ) {
              console.log( "Error: " + errorThrown );
              console.log( "Status: " + status );
            }
          });
        },
        error: function( xhr, status, errorThrown ) {
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
        }
      });
    }
    function queryComponents(providerId, appName) {
      console.log("appName:" + appName);
      $.ajax({
        url: '/api4gui/v1/providers/' + providerId + '/',
        type: "GET",
        success: function(provider) {
          $.ajax({
            url: '/rest/ucd/applications/' + appName + '/components',
            type: "GET",
            crossDomain: true,
            beforeSend: function(xhr) {
              xhr.setRequestHeader('UCD_SERVER', provider.UCD_SERVER);
              xhr.setRequestHeader('UCD_USERNAME', provider.UCD_USERNAME);
              xhr.setRequestHeader('UCD_PASSWORD', provider.UCD_PASSWORD);
            },
            success: function(json) {
              if ($.isEmptyObject(json)) {
                //alert( "Cannot find any components in specified application!" );
                return;
              }
              $('div[id^=div_component_]').remove();
              var count=0;
              var with_saved_components=false;
              var appProcessTemplate,appProcessTemplate_obj;
              var versions;
              appProcessTemplate=$('#div_process_template input').val();
              if(appName=="#{topology.appName}"){
                  with_saved_components=true;
                  console.log('appProcessTemplate:'+appProcessTemplate);
                  appProcessTemplate_obj=JSON.parse(appProcessTemplate);
                  versions=JSON.parse(appProcessTemplate).versions;
              }
              json.forEach(function(component) {
                count++;
                console.log('count:'+count);
                if(with_saved_components){
                var version_string;
                version_string=versions[count-1].version;
                $('#div_separator').after('<div id="div_component_'+count+' class="row"> <div class="span3"> <p id="p_component_'+count+'">'+component.name +'</p> </div> <div> <input id="input_version_'+count+'" class="span6 xlarge" value="'+version_string+'"> </div> </div>');
                } else
                $('#div_separator').after('<div id="div_component_'+count+' class="row"> <div class="span3"> <p id="p_component_'+count+'">'+component.name +'</p> </div> <div> <input id="input_version_'+count+'" class="span6 xlarge"> </div> </div>');
              });//json.forEach
              $('#div_separator').after('<div id="div_component_total" class="row"> <div class="span3">  </div> <div> <input id="input_total" class="span6 xlarge" type="hidden" value="'+count+'"> </div> </div>');
            },
            error: function( xhr, status, errorThrown ) {
              console.log( "Error: " + errorThrown );
              console.log( "Status: " + status );
            }
          });
        },
        error: function( xhr, status, errorThrown ) {
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
        }
      });
    }
    function generateFormData(){
      console.log('In function generateFormData:');
      var count;
      count=$('#input_total').val();

      console.log('number of components:'+count);
      var i;
      var component, version;
      var application, applicationProcess, properties, versions, version_array;
      var template;
      var template_obj={};

      application=$('#div_application select').val();
      applicationProcess=$('#div_process input').val();
      properties=$('#div_process_properties textarea').val();
      console.log('applicationProcess:'+applicationProcess);
      console.log('applicationProcess Properties:'+properties);
      template_obj["application"]=application;
      template_obj["applicationProcess"]=applicationProcess;
      template_obj["properties"]=properties;

      version_array=[];
      for(i=1;i<=count; i++){
         component=$('#p_component_'+i).text();
         version=$('#input_version_'+i).val();
         console.log('component:'+component);
         console.log('version:'+version);
         version_array[i-1]={};
         version_array[i-1].version=version;
         version_array[i-1].component=component;
      }
      template_obj["versions"]=version_array;
      template=JSON.stringify(template_obj);
      $('#div_process_template input').val(template);
      console.log('generated template:'+template);
    }
    $(document).ready(function() {
      $("#input_submit").click(function(e){
      // e.preventDefault();
       var form = this;
       generateFormData();
      });
      $('#div_provider select').bind('change', function(event) {
          $('#div_application select').empty();
          $('#div_blueprint select').empty();
          $('#div_nodeprops textarea').val('');
          queryApplications($(this).val());
        });
      $('#div_application select').bind('change', function(event) {
          $('#div_blueprint select').empty();
          $('#div_nodeprops textarea').val('');
          queryBlueprints($('#div_provider select').val(), $(this).val());
          queryComponents($('#div_provider select').val(), $(this).val());
        });
      $('#div_blueprint select').bind('change', function(event) {
          $('#div_nodeprops textarea').val('');
          queryNodeProperties($('#div_provider select').val(), $('#div_application select').val(), $(this).val());
        });
      queryProviders();
      queryApplications("#{topology.providerRef}");
      queryBlueprints("#{topology.providerRef}", "#{topology.appName}");
      queryComponents("#{topology.providerRef}", "#{topology.appName}");
    });//ready

  form(method='post', action='/topology/topologies/' + topology.id)
    input(name='_method', value='PUT', type='hidden')
    fieldset
      legend Editing topology
      div.clearfix
        div.input
          div.row
            div.span3 
              p Name
            div
              input.span3(name='topology[name]', class='xlarge', value="#{topology.name}")
          div.row
            div.span3 
              p Description
            div
              input.span6(name='topology[description]', class='xlarge', value="#{topology.description}")
          div.row(id="div_provider")
            div.span3
              p Provider
            div
                select(name='topology[providerRef]')
          div.row(id="div_application")
            div.span3
              p Application
            div
                select(name='topology[appName]')
          div.row(id="div_blueprint")
            div.span3
              p Blueprint
            div
                select(name='topology[blueprintName]')
          div.row(id="div_nodeprops")
            div.span3 
              p 
            div
              input.span6(name='topology[nodeProperties]', type='hidden', rows=20, class='xlarge', value='#{topology.nodeProperties}')
          div.row(id="div_process")
            div.span3
              p Process Name
            div
              input.span6(name='topology[appProcessName]', class='xlarge', value='#{topology.appProcessName}')
          div.row(id="div_process_properties")
            div.span3
              p Process Properties
            div
              textarea.span6(name='topology[processProperties]', rows=5, class='xlarge') #{topology.processProperties} 
          div.row(id="div_separator")
            div.span3
              p Components
            div
              p Versions
          div.row(id="div_process_template")
            div.span3
            div
              input.span6(name='topology[appProcessTemplate]', type='hidden', class='xlarge', value='#{topology.appProcessTemplate}')
        div.actions
          input.offset3(id='input_submit', type='submit', value='Save', class='btn primary')
          button.offset1(type='reset', class='btn') Cancel

